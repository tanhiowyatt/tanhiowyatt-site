# NGINX Configuration with Subdomains (SSL Terminated by WAF)
# Nginx listens ONLY on port 80 (HTTP) - WAF handles SSL and certificates

upstream tanhio_app {
    server localhost:5173;
}

# ðŸ”¥ MAIN SITE tanhio.dev & http -> https redirect
server {
    listen 80;
    listen [::]:80;
    server_name tanhio.dev www.tanhio.dev;

    # Security Headers (WAF may overwrite, but good to have)
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    
    # Anti-smuggling
    underscores_in_headers off;
    ignore_invalid_headers on;
    
    # Root for static files
    root /var/www/tanhio_site;
    index index.html;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=general:10m rate=100r/10s;

    # 1. Force HTTPS via WAF (X-Forwarded-Proto)
    # If the request coming from WAF is HTTP, redirect to HTTPS.
    # This prevents infinite loops if WAF talks to us over HTTP.
    if ($http_x_forwarded_proto = "http") {
        return 301 https://$host$request_uri;
    }

    location / {
        limit_req zone=general burst=50 nodelay;
        try_files $uri $uri/ @app;
    }

    # Proxy to Node.js App
    location @app {
        proxy_pass http://tanhio_app;
        proxy_http_version 1.1;
        proxy_request_buffering on;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ðŸš« Block H2C smuggling
        proxy_set_header Upgrade "";
        proxy_set_header Connection "";
    }

    # Static Cache
    location ~* \.(js|css|png|jpg|jpeg|gif|webp|svg|woff2?|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# ðŸ”¥ RESUME cv.tanhio.dev
server {
    listen 80;
    listen [::]:80;
    server_name cv.tanhio.dev;
    
    # WAF HTTPS Redirect
    if ($http_x_forwarded_proto = "http") {
        return 301 https://$host$request_uri;
    }

    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;

    # Root MUST be a directory, not a file
    root /var/www/tanhio_site/files;
    index tanhiowyatt_CV.pdf;

    # Serve the PDF for root requests or fallbacks
    location / {
        try_files $uri $uri/ /tanhiowyatt_CV.pdf;
    }

    location ~* \.pdf$ {
        add_header Content-Type "application/pdf";
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# ðŸ”¥ BLOG blog.tanhio.dev
server {
    listen 80;
    listen [::]:80;
    server_name blog.tanhio.dev;
    
    # WAF HTTPS Redirect
    if ($http_x_forwarded_proto = "http") {
        return 301 https://$host$request_uri;
    }

    add_header X-Content-Type-Options nosniff always;
    
    root /var/www/tanhio_site/blog;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}

# Gzip
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;
